{% extends 'base.html' %}
{% load static %}

{% block title %}AI HR Assistant{% endblock %}

{% block content %}
<style>
    /* --- Main Chat Container --- */
    .chat-container {
        max-width: 800px;
        margin: 2rem auto;
        background: var(--white-color);
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        /* The AI Glow Animation */
        animation: pulseGlow 4s infinite alternate ease-in-out;
    }

    @keyframes pulseGlow {
        from {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        to {
            box-shadow: 0 10px 40px rgba(106, 90, 205, 0.25);
        }
    }

    /* --- Chat Header --- */
    .chat-header {
        padding: 20px 30px;
        background: var(--secondary-color);
        color: var(--white-color);
        border-bottom: 1px solid #3c4a5c;
        text-align: center;
    }
    .chat-header h2 {
        margin: 0;
        font-size: 1.5rem;
        color: var(--white-color);
        border: none;
    }
    .chat-header h2 .icon {
        vertical-align: middle;
        margin-right: 10px;
        font-size: 1.2em;
    }

    /* --- Chat Window (The conversation area) --- */
    .chat-window {
        flex-grow: 1;
        padding: 30px;
        display: flex;
        flex-direction: column;
        gap: 25px;
        overflow-y: auto;
        min-height: 400px;
        background-color: var(--background-color);
    }

    /* --- Chat Messages --- */
    .chat-message {
        display: flex;
        gap: 15px;
        max-width: 85%;
        animation: popIn 0.4s ease-out forwards;
    }
    @keyframes popIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }

    /* User's messages align to the right */
    .user-message {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    /* Assistant's messages align to the left */
    .assistant-message {
        align-self: flex-start;
    }

    .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--white-color);
        flex-shrink: 0;
    }
    .user-message .avatar {
        background: var(--primary-color);
    }
    .assistant-message .avatar {
        background: #6b7280; /* Gray for the bot */
    }

    .message-text {
        padding: 15px 20px;
        border-radius: 12px;
        line-height: 1.6;
    }
    .user-message .message-text {
        background: var(--primary-color);
        color: var(--white-color);
        border-bottom-right-radius: 0;
    }
    .assistant-message .message-text {
        background: var(--white-color);
        color: var(--secondary-color);
        border-bottom-left-radius: 0;
        box-shadow: var(--shadow-sm);
    }

    /* --- Typing Indicator Animation --- */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: #9ca3af;
        border-radius: 50%;
        animation: typing 1.2s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-6px); }
    }
    
    /* --- Input Form --- */
    .chat-input-form {
        padding: 20px 30px;
        background: var(--white-color);
        border-top: 1px solid var(--light-gray);
    }
    .suggested-questions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }
    .suggested-questions button {
        background: var(--light-gray);
        border: 1px solid #e5e7eb;
        border-radius: 50px;
        padding: 8px 15px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .suggested-questions button:hover {
        background: #e5e7eb;
        border-color: #d1d5db;
    }

    .chat-input-wrapper {
        display: flex;
        gap: 10px;
    }
    .chat-input-wrapper input {
        flex-grow: 1;
        padding: 14px 20px;
        border: 1px solid #d1d5db;
        border-radius: 50px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .chat-input-wrapper input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.2);
    }
    .chat-input-wrapper button {
        flex-shrink: 0;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: var(--primary-color);
        color: var(--white-color);
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }
    .chat-input-wrapper button:hover {
        background-color: var(--accent-color);
        transform: scale(1.1);
    }
</style>

<div class="chat-container">
    <div class="chat-header">
        <h2><i class='bx bxs-bot icon'></i> AI HR Assistant</h2>
    </div>

    <div class="chat-window" id="chat-window">
        <!-- Initial Welcome Message -->
        <div class="chat-message assistant-message">
            <div class="avatar"><i class='bx bxs-bot'></i></div>
            <div class="message-text">
                Hello {{ user.first_name|default:user.username }}! I'm your AI-powered HR Assistant. How can I help you today? You can ask me about company policy, leave requests, or payroll information.
            </div>
        </div>
        
        <!-- Django renders the previous conversation here -->
        {% if question and answer %}
            <!-- User's Question -->
            <div class="chat-message user-message">
                <div class="avatar"><i class='bx bxs-user'></i></div>
                <div class="message-text">
                    {{ question }}
                </div>
            </div>
            
            <!-- Assistant's Answer -->
            <div class="chat-message assistant-message">
                <div class="avatar"><i class='bx bxs-bot'></i></div>
                <div class="message-text">
                    {{ answer|linebreaks }}
                </div>
            </div>
        {% endif %}
    </div>

    <form method="POST" class="chat-input-form" id="chat-form">
        {% csrf_token %}
        <div class="suggested-questions">
            <button type="button" class="suggestion-btn">What is our leave policy?</button>
            <button type="button" class="suggestion-btn">How do I submit an expense report?</button>
            <button type="button" class="suggestion-btn">When is the next payday?</button>
        </div>
        <div class="chat-input-wrapper">
            <input type="text" name="question" id="question-input" placeholder="Ask a question..." required autocomplete="off">
            <button type="submit" aria-label="Send"><i class='bx bxs-send'></i></button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const questionInput = document.getElementById('question-input');
    const suggestionBtns = document.querySelectorAll('.suggestion-btn');

    // Automatically scroll to the bottom of the chat on page load
    chatWindow.scrollTop = chatWindow.scrollHeight;

    // Handle form submission to show typing indicator
    chatForm.addEventListener('submit', function(e) {
        // Prevent empty submissions from showing indicator
        if (!questionInput.value.trim()) {
            e.preventDefault();
            return;
        }

        // Show the user's message immediately for a faster feel (optional)
        const userMessageHTML = `
            <div class="chat-message user-message">
                <div class="avatar"><i class='bx bxs-user'></i></div>
                <div class="message-text">${questionInput.value}</div>
            </div>
        `;
        // chatWindow.insertAdjacentHTML('beforeend', userMessageHTML);

        // Add the typing indicator
        const typingIndicatorHTML = `
            <div class="chat-message assistant-message" id="typing-indicator">
                <div class="avatar"><i class='bx bxs-bot'></i></div>
                <div class="message-text">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        `;
        chatWindow.insertAdjacentHTML('beforeend', typingIndicatorHTML);

        // Scroll to the new indicator
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    // Handle suggestion button clicks
    suggestionBtns.forEach(button => {
        button.addEventListener('click', () => {
            questionInput.value = button.textContent;
            questionInput.focus();
        });
    });
});
</script>

{% endblock %}